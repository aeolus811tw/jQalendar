$.widget("aekt.tcalendar",{options:{date:new Date,mode:"m",debug:false,agenda:[]},_millisec_day:864e5,_millisec_year:31536e6,_weekCellWidth:[0,0,0,0,0,0,0],_todayDatePicker:null,_modeChanger:null,_weekNameFull:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],_weekNameShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],_monthNameFull:["January","February","March","April","May","June","July","August","September","October","November","December"],_monthNameShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],_mode:{y:{name:"Year",func:{grid:"_yearGrid",dimension:"_yearDimension",date:"_yearDate",refresh:"_yearRefresh",next:"_yearNext",prev:"_yearPrev"}},m:{name:"Month",func:{grid:"_monthGrid",dimension:"_monthDimension",date:"_monthDate",refresh:"_monthRefresh",next:"_monthNext",prev:"_monthPrev"}},w:{name:"Week",func:{grid:"_weekGrid",dimension:"_weekDimension",date:"_weekDate",refresh:"_weekRefresh",next:"_weekNext",prev:"_weekPrev"}},d:{name:"Day",func:{grid:"_dayGrid",dimension:"_dayDimension",date:"_dayDate",refresh:"_dayRefresh",next:"_dayNext",prev:"_dayPrev"}},a:{name:"Agenda",func:{grid:"_agendaGrid",dimension:"_agendaDimension",refresh:"_agendaRefresh",next:"_agendaNext",prev:"_agendaPrev"}}},_create:function(){var e=this;e.element.children().remove();e.element.addClass("tcal-caledar");e.element.data("index",$(".tcal-calendar").length+1);var t=e.element.data("index");var n=$("<div/>",{"class":"tcal-header",id:"tcal-header-"+t});var r=$("<div/>",{"class":"tcal-header-title-container"});var i=$("<span/>",{"class":"tcal-header-primary-title",html:"Month"});var s=$("<span/>",{"class":"tcal-header-secondary-title",html:"Year"});r.append(i).append(s);var o=$("<button/>",{"class":"tcal-next-btn",html:">"}).button().click(function(t){e.next();e._todayDatePicker.datepicker("setDate",e.options.date)});var u=$("<button/>",{"class":"tcal-prev-btn",html:"<"}).button().click(function(t){e.prev();e._todayDatePicker.datepicker("setDate",e.options.date)});var a=$("<button/>",{"class":"tcal-today-btn",html:"Today"}).button().click(function(t){e.options.date=new Date;e._todayDatePicker.datepicker("setDate",e.options.date);e.datefix();e.refresh();e._trigger("today")});this._todayDatePicker=$("<input/>",{"class":"tcal-today-field",placeholder:"MM/DD/YYYY"});this._todayDatePicker.datepicker({constrainInput:true,dateFormat:"mm/dd/yy",numberOfMonths:1,onSelect:function(t,n){e.options.date=e._todayDatePicker.datepicker("getDate");e.datefix();e.refresh();e._trigger("today")}}).datepicker("setDate",e.options.date);var f=$("<div/>",{"class":"tcal-grid",id:"tcal-grid-"+t});var l=$("<div/>",{"class":"tcal-header-ext"});e.element.append(n).append(l).append(f);e._modeChanger=$("<span/>",{"class":"tcal-header-modechanger",id:"tcal-header-modechanger-"+t,html:""});for(var c in e._mode){var h=$("<input/>",{type:"radio",id:"tcal-header-"+t+"-"+c,name:"tcal-header-"+t+"-modechanger",value:c}).data("mode",c);var p=$("<label/>",{"for":"tcal-header-"+t+"-"+c,html:e._mode[c].name});e._modeChanger.append(h).append(p);if(c===e.options.mode){h.prop("checked",true)}else{h.prop("checked",false)}}e._modeChanger.buttonset();e._modeChanger.find(":input").change(function(t){e.changeMode($(this).data("mode"))});var d=$("<ul/>");var v=$("<li/>",{html:"Print"});var m=$("<li/>",{html:"Refresh"});d.append(v).append(m);d.hide().menu();var g=$("<button/>",{"class":"tcal-more-func-btn",html:"More"}).button({icons:{secondary:"ui-icon-triangle-1-s"}}).click(function(){var e=d.show().position({my:"right top",at:"right bottom",of:this});$(document).one("click",function(){d.hide()});return false});n.append(a).append(this._todayDatePicker).append(u).append(o).append(g).append(d).append(e._modeChanger).append(r);n.append($("<div/>"));e.gridfix();e.datefix();e.refresh();$(window).resize(function(t){var r=$(window).height();var i=n.height();f.css("height",r-i-40);e.dimensionfix()}).resize()},_setOption:function(e,t){this.options[e]=t},destroy:function(){this.element.children().remove();this.element.removeClass("tcal-caledar");this.element.data("index","");$.Widget.prototype.destroy.call(this)},addAgenda:function(e){try{if(this._verifyAgenda(e)){if(this.options.debug){console.log("addAgenda:"+e.startDate.toString()+" to "+e.endDate.toString())}this.options.agenda.push(e)}this.refresh()}catch(t){if(this.options.debug)console.log(t)}},getAgendaById:function(e){var t;$.each(this.options.agenda,function(n,r){if(r.id==e)t=r});return t},updateAgendaById:function(e,t){var n=-1;$.each(this.options.agenda,function(e,r){if(r.id==t.id)n=e});if(n>=0){$.extend(true,this.options.agenda[n],t);if(this.options.debug){console.log("updateAgendaById: updated Agenda with Id "+e)}return this.options.agenda[n]}if(this.options.debug){console.log("updateAgendaById: no agenda with Id "+e+" was found.")}},changeMode:function(e){if(this._mode[e]){this._modeChanger.find("input").prop("checked",false);this._modeChanger.find("input[value="+e+"]").prop("checked",true);this._modeChanger.buttonset("refresh");this.options.mode=e;this.gridfix();this.dimensionfix();this.datefix();this.refresh()}},refresh:function(){if(this._mode[this.options.mode]&&this._mode[this.options.mode].func&&this._mode[this.options.mode].func.refresh){this[this._mode[this.options.mode].func.refresh]()}},gridfix:function(){if(this._mode[this.options.mode]&&this._mode[this.options.mode].func&&this._mode[this.options.mode].func.grid){this[this._mode[this.options.mode].func.grid]()}},dimensionfix:function(){if(this._mode[this.options.mode]&&this._mode[this.options.mode].func&&this._mode[this.options.mode].func.dimension){this[this._mode[this.options.mode].func.dimension]()}},datefix:function(){if(this._mode[this.options.mode]&&this._mode[this.options.mode].func&&this._mode[this.options.mode].func.date){this[this._mode[this.options.mode].func.date]()}},next:function(){var e=this;if(this._mode[this.options.mode]&&this._mode[this.options.mode].func&&this._mode[this.options.mode].func.next){this[this._mode[this.options.mode].func.next]()}e.datefix();e.refresh()},prev:function(){var e=this;if(this._mode[this.options.mode]&&this._mode[this.options.mode].func&&this._mode[this.options.mode].func.prev){this[this._mode[this.options.mode].func.prev]()}e.datefix();e.refresh()},_onAgendaClick:function(e){var t=$(e);this._trigger("agendaClick",null,[$(e),this.getAgendaById(t.data("id"))])},_onAgendaMouseEnter:function(e){var t=$(e);this._trigger("agendaMouseEnter",null,[$(e),this.getAgendaById(t.data("id"))]);this.dimensionfix()},_onAgendaMouseExit:function(e){var t=$(e);this._trigger("agendaMouseExit",null,[$(e),this.getAgendaById(t.data("id"))])},_isToday:function(e){var t=new Date;var n=e.getMonth()==t.getMonth()&&e.getFullYear()==t.getFullYear()&&e.getDate()==t.getDate();return n},_isSameDay:function(e,t){var n=e.getMonth()==t.getMonth()&&e.getFullYear()==t.getFullYear()&&e.getDate()==t.getDate();return n},_sortAgendaByDate:function(e,t){var n=e.startDate.getTime();var r=t.startDate.getTime();var i=e.endDate.getTime();var s=t.endDate.getTime();return n<r?-1:n>r?1:i<s?-1:i>s?1:0},_verifyAgenda:function(e){if(typeof e.id==="undefined"){throw"missing id field"}else{$.each(this.options.agenda,function(t,n){if(n.id==e.id)throw"cannot have duplicated id, each id must be unique"})}if(e.startDate){if(typeof e.startDate=="string")e.startDate=new Date(e.startDate);else if(typeof e.startDate=="object")1==1;else throw"invalid startDate detected"}else{throw"missing startDate field"}if(typeof e.title==="undefined"){throw"missing title field"}if(e.endDate){if(typeof e.endDate=="string")e.endDate=$.datepicker.parseDate("yy-mm-dd",e.endDate);else if(typeof e.endDate=="object")1==1;else throw"invalid endDate field detected"}else{throw"missing endDate field"}if(e.endDate.getTime()<=e.startDate.getTime())throw"endDate must be greater than startDate";if(typeof e.allDay!=="boolean"){throw"invalid allDay field field, must be a boolean value"}if(typeof e.repeat!="object"){throw"invalid repeat field detected"}if(typeof e.color!=="string"){throw"invalid color field detected, must be a valid CSS color string"}if(typeof e.calendar!="string"){throw"invalid calendar field detected, must be a string value"}return true},_agendaGrid:function(){var e=this.element.find(".tcal-grid");var t=$("<div/>",{"class":"tcal-grid-agenda-scrollpanel"}).css("overflow","auto");var n=$("<div/>",{"class":"tcal-grid-agenda-content"});var r=this.element.find(".tcal-header-ext");e.children().remove();e.append(t);t.append(n);r.children().remove()},_agendaDimension:function(){var e=this;var t=this.element.find(".tcal-grid").css("width",e.element.width()-20);var n=t.height();var r=t.find(".tcal-grid-agenda-content");var i=t.find(".tcal-grid-agenda-scrollpanel");i.css("width",t.width()+15).css("height",n);r.find(".tcal-view-agenda").css("width",t.width())},_agendaPrev:function(){this.options.date.setTime(this.options.date.getTime()-this._millisec_day*120)},_agendaNext:function(){this.options.date.setTime(this.options.date.getTime()+this._millisec_day*120)},_agendaRefresh:function(){var e=this;var t=this.element.find(".tcal-grid");var n=t.find(".tcal-grid-agenda-content");n.children().remove();var r=e.element.find(".tcal-header");var i=e.options.date.getFullYear();var s=e.options.date.getDate();var o=e.options.date.getMonth();var u=new Date(i,o,s,0,0,0,0);var a=new Date(u.getTime()+e._millisec_day*120);var f=$.grep(e.options.agenda,function(e,t){var n=e.startDate.getTime()<a.getTime()&&e.startDate.getTime()>=u.getTime();var r=e.endDate.getTime()<a.getTime()&&e.endDate.getTime()>u.getTime();var i=e.startDate.getTime()<u.getTime()&&e.endDate.getTime()>a.getTime();return n||r||i});r.find(".tcal-header-primary-title").html(e.options.date.toLocaleDateString()+" - "+a.toLocaleDateString());r.find(".tcal-header-secondary-title").html("");$.each(f,function(r,i){var s=$("<div/>",{"class":"tcal-view-agenda"});s.css("width",t.width());var o=$("<div/>",{"class":"tcal-view-agenda-startdate"});var u=$("<span/>",{html:i.startDate.toDateString()}).data("year",i.startDate.getFullYear()).data("month",i.startDate.getMonth()+1).data("day",i.startDate.getDate()).click(function(t){var n=$(this);e._todayDatePicker.datepicker("setDate",n.data("month")+"/"+n.data("day")+"/"+n.data("year"));e.changeMode("d")});o.append(u);var a=$("<div/>",{"class":"tcal-view-agenda-enddate"});a.html(i.allDay?"All Day":i.endDate.toLocaleTimeString()+" - "+i.startDate.toLocaleTimeString());var f=$("<div/>",{"class":"tcal-view-agenda-label"});var l=$("<span/>",{html:i.title}).data("id",i.id).css("color",i.color);l.click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(l,i)}f.append(l);s.append(o).append(a).append(f);n.append(s)})},_dayGrid:function(){var e=this.element.find(".tcal-grid");var t=$("<div/>",{"class":"tcal-grid-day-scrollpanel"}).css("overflow","auto");var n=$("<div/>",{"class":"tcal-grid-day-alldaypanel"}).css("position","fixed").css("margin-top","-1px");var r=$("<div/>",{"class":"tcal-grid-day-content"});e.children().remove();e.append(t);t.append(n).append(r);var i=this.element.find(".tcal-header-ext");i.children().remove();i.append($("<div/>",{"class":"tcal-day-label-cell",html:"&nbsp;"}).css("border","none"));n.append($("<div/>",{"class":"tcal-day-label-cell",html:"<span class='tcal-day-label-text'></span>"}));var s=$("<div/>",{"class":"tcal-day-allday-cell"});n.append(s);s=$("<div/>",{"class":"tcal-day-header-cell",html:"<span class='tcal-day-header-cell-weekday'>"+this._weekNameShort[this.options.date.getDay()]+"</span><span class='tcal-day-header-cell-date'></span>"});i.append(s);i.append($("<div/>",{style:"clear:both;"}));var o=0;for(var u=0;u<96;u++){var s;if(u%2!=0){s=$("<div/>",{"class":"tcal-day-halfhour-cell"})}else{if(u%4==0){if(o<10)s=$("<div/>",{"class":"tcal-day-label-cell",html:"<span class='tcal-day-label-text'>0"+o+":00</span>"});else s=$("<div/>",{"class":"tcal-day-label-cell",html:"<span class='tcal-day-label-text'>"+o+":00</span>"});o=(o+1)%24}else{s=$("<div/>",{"class":"tcal-day-label-cell"})}}r.append(s)}r.append($("<div/>").css("clear","both"))},_dayDimension:function(){var e=this;var t=e.element.find(".tcal-grid");t.css("width",e.element.width()-20);var n=e.element.find(".tcal-grid-day-scrollpanel");var r=e.element.find(".tcal-grid-day-content").css("width",t.width()+1);var i=n.find(".tcal-grid-day-alldaypanel").css("width",t.width()+1);var s=this.element.find(".tcal-header-ext");var o=t.height();var u=52;var a=t.width()-u;var f=Math.trunc(o*2.5/48);n.css("width",t.width()+15).css("height",o);r.css("margin-top",f*4-1);s.find(".tcal-day-header-cell").css("width",a-2);s.find(".tcal-day-label-cell").css("width",u);n.find(".tcal-day-label-cell").each(function(e){var t=$(this);var n=e-1;t.css("width",u).css("margin-right","-1px");if(n<0){t.css("height",f*4)}else{if(n%2==0){t.css("border-bottom","none")}else{t.css("border-top","none")}t.css("height",f)}});n.find(".tcal-day-allday-cell").css("width",a).css("border-right","1px solid #dedede").css("height",f*4);n.find(".tcal-day-halfhour-cell").css("width",a).css("height",f).css("border-right","1px solid #dedede");n.find(".tcal-day-agenda-actual").each(function(e){var t=$(this);var n=t.parent();var r=t.data("width");var i=n.height()/30*r.marginTopOffset;var s=(a-5-r.intersectCount*4)/r.intersectCount;t.css("width",s).css("margin-top",i).css("height",n.height()*r.numberCellHeight+(r.numberCellHeight-1)*2).css("margin-left",r.startedWidthUnit*(s+4))})},_dayDate:function(){var e=this;var t=e.element.find(".tcal-grid");var n=e.element.find(".tcal-header-ext");var r=e.element.find(".tcal-header");var i=e.options.date.getMonth();var s=e.options.date.getDate();var o=e.options.date.getFullYear();r.find(".tcal-header-primary-title").html(e.options.date.toDateString());r.find(".tcal-header-secondary-title").html("");n.find(".tcal-day-header-cell-date").each(function(t,n){var r=$(this);$(n).html(i+1+"/"+s);if(e._isToday(e.options.date)){r.addClass("tcal-day-today")}else{r.removeClass("tcal-day-today")}});t.find(".tcal-day-halfhour-cell, .tcal-day-allday-cell").each(function(){var e=$(this);e.removeClass("tcal-day-halfhour-allday");e.children().remove()})},_dayPrev:function(){this.options.date.setTime(this.options.date.getTime()-this._millisec_day)},_dayNext:function(){this.options.date.setTime(this.options.date.getTime()+this._millisec_day)},_dayRefresh:function(){var e=this;var t=e.options.date.getMonth();var n=e.options.date.getFullYear();var r=e.options.date.getDate();var i=new Date(n,t,r,0,0,0,0);var s=new Date(i.getTime()+e._millisec_day);var o=e.element.find(".tcal-grid");o.find(".tcal-day-agenda").remove();var u=e.element.find(".tcal-grid-day-scrollpanel");var a=$(u.find(".tcal-day-allday-cell"));var f=[];var l=$(".tcal-grid-day-content .tcal-day-halfhour-cell");var c=$.grep(e.options.agenda,function(t,n){var r=t.startDate.getTime()<s.getTime()&&t.startDate.getTime()>=i.getTime();var o=t.endDate.getTime()<s.getTime()&&t.endDate.getTime()>i.getTime();var u=t.startDate.getTime()<i.getTime()&&t.endDate.getTime()>s.getTime();if(e._isSameDay(t.startDate,t.endDate)&&t.allDay==false){if(r||o){f.push(t)}return false}else{return r||o||u}});var h=function(e){u.find(".tcal-day-halfhour-cell").addClass("tcal-day-halfhour-allday")};c.sort(e._sortAgendaByDate);f.sort(e._sortAgendaByDate);$.each(c,function(t,n){if(e._isSameDay(n.startDate,n.endDate)){var r=$("<div/>",{"class":"tcal-day-allday-agenda tcal-day-allday-agenda-used tcal-day-allday-actual"}).css("background-color",n.color);var o=$("<div/>",{html:n.title,"class":"tcal-day-agenda-title"});r.append(o).css("width",a.width()-5).data("id",n.id);a.append(r).addClass("tcal-day-halfhour-allday");h(n.startDate);r.click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(r,n)}}else{var u={startedHeight:0,firstday:null};var r;var o=$("<div/>",{html:n.title,"class":"tcal-day-agenda-title"});u.firstday=new Date(n.startDate.getFullYear(),n.startDate.getMonth(),n.startDate.getDate(),0,0,0,0);if(u.firstday.getTime()<i.getTime()){u.firstday.setTime(i.getTime())}var f=a.children();if(f.length>0){$.each(f,function(e,t){if($(t).hasClass("tcal-day-allday-agenda-used"))u.startedHeight=e+1;else{return false}});if(f.length>u.startedHeight){r=$(f[u.startedHeight])}else{r=$("<div/>");a.append(r)}}else{r=$("<div/>");a.append(r)}r.data("id",n.id).addClass("tcal-day-allday-agenda tcal-day-allday-agenda-used tcal-day-allday-actual").css("background-color",n.color);r.click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(r,n)}if(n.endDate.getTime()<s){u.upToDate=new Date(n.endDate.getFullYear(),n.endDate.getMonth(),n.endDate.getDate(),0,0,0,0);u.upToDate.setTime(u.upToDate.getTime()+e._millisec_day)}else{u.upToDate=new Date(s.getTime())}r.css("width",a.width()-5);a.append(r).addClass("tcal-day-halfhour-allday");h(u.firstday);var l=new Date(u.firstday.getTime());for(;l.getTime()<u.upToDate.getTime();l.setTime(l.getTime()+e._millisec_day)){if(a.children().length<=u.startedHeight){for(var c=a.children().length;c<=u.startedHeight;c++){a.append($("<div/>",{"class":"tcal-day-allday-agenda tcal-day-allday-agenda-used"}).css("width",a.width()-5))}}else{$(a.children()[u.startedHeight]).addClass("tcal-day-allday-agenda-used")}a.addClass("tcal-day-halfhour-allday");h(l)}var p=$("<div/>",{"class":"tcal-day-agenda-allday-start-time"});if(i.getTime()<=n.startDate.getTime()){var d=n.startDate.getHours();var v=n.startDate.getMinutes();p.html((d<10?"0"+d:d)+":"+(v<10?"0"+v:v))}else{p.addClass("tcal-day-not-start-here")}var m=$("<div/>",{"class":"tcal-day-agenda-allday-end-time"});if(s.getTime()>n.endDate.getTime()){var d=n.endDate.getHours();var v=n.endDate.getMinutes();m.html((d<10?"0"+d:d)+":"+(v<10?"0"+v:v))}else{m.addClass("tcal-day-not-end-here")}r.append(p).append(o).append(m)}});$.each(f,function(t,n){var r={column:0,start_loc:{y:n.startDate.getMinutes()>29?1:0},end_loc:{y:n.endDate.getMinutes()>29?1:0},started:false,startedWidthUnit:0,intersectCount:0,numberCellHeight:0,marginTopOffset:n.startDate.getMinutes()%30};r.start_loc.y+=n.startDate.getHours()*2;r.end_loc.y+=n.endDate.getHours()*2;var i=r.start_loc.y;var s=$(l[i]);r.numberCellHeight=(n.endDate.getTime()-n.startDate.getTime())/18e5;var o=$.grep(f,function(e,i){var s=false;var o=false;if(e.startDate.getTime()>=n.endDate.getTime()){s=true}if(e.endDate.getTime()<=n.startDate.getTime()){o=true}if(o==s&&i<t)r.startedWidthUnit++;return o==s});r.intersectCount=o.length;var u=s.height()/30*r.marginTopOffset;var a=(s.width()-r.startedWidthUnit*4-5)/o.length;var c=$("<div/>",{"class":"tcal-day-agenda tcal-day-agenda-used tcal-day-agenda-actual"}).css("background-color",n.color).css("width",a).data("width",r).css("margin-top",u).css("height",s.height()*r.numberCellHeight+(r.numberCellHeight-1)*2).css("margin-left",r.startedWidthUnit*(a+4));var h=$("<div/>",{html:n.title,"class":"tcal-day-agenda-title"});c.append(h).data("id",n.id);s.append(c);c.click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(c,n)}})},_weekGrid:function(){var e=this.element.find(".tcal-grid");var t=$("<div/>",{"class":"tcal-grid-week-scrollpanel"}).css("overflow","auto");var n=$("<div/>",{"class":"tcal-grid-week-alldaypanel"}).css("position","fixed").css("margin-top","-1px");var r=$("<div/>",{"class":"tcal-grid-week-content"});e.children().remove();e.append(t);t.append(n).append(r);var i=this.element.find(".tcal-header-ext");i.children().remove();i.append($("<div/>",{"class":"tcal-week-label-cell",html:"&nbsp;"}).css("border","none"));n.append($("<div/>",{"class":"tcal-week-label-cell",html:"<span class='tcal-week-label-text'></span>"}));for(var s=0;s<7;s++){var o=$("<div/>",{"class":"tcal-week-allday-cell"});n.append(o);o=$("<div/>",{"class":"tcal-week-header-cell",html:"<span class='tcal-week-header-cell-day'>"+this._weekNameShort[s]+"</span><span class='tcal-week-header-cell-date'></span>"});i.append(o)}i.append($("<div/>",{style:"clear:both;"}));var u=0;for(var s=0;s<384;s++){var o;if(s%8!=0){o=$("<div/>",{"class":"tcal-week-halfhour-cell"})}else{if(s%16==0){if(u<10)o=$("<div/>",{"class":"tcal-week-label-cell",html:"<span class='tcal-week-label-text'>0"+u+":00</span>"});else o=$("<div/>",{"class":"tcal-week-label-cell",html:"<span class='tcal-week-label-text'>"+u+":00</span>"});u=(u+1)%24}else{o=$("<div/>",{"class":"tcal-week-label-cell"})}}r.append(o)}r.append($("<div/>").css("clear","both"))},_weekDimension:function(){var e=this;var t=e.element.find(".tcal-grid");t.css("width",e.element.width()-20);var n=e.element.find(".tcal-grid-week-scrollpanel");var r=e.element.find(".tcal-grid-week-content");var i=this.element.find(".tcal-header-ext");var s=t.height();var o=52;var u=t.width()-o+1;var a=Math.trunc(u/7);var f=Math.trunc(s*2.5/48);var l=(u-a*7)/2+a;n.css("width",t.width()+15).css("height",s);r.css("margin-top",f*4-1);i.find(".tcal-week-header-cell").each(function(e){var t=e%7;var n=$(this);if(t==6||t==0)n.css("width",l-1);else n.css("width",a-1)});i.find(".tcal-week-label-cell").css("width",o);n.find(".tcal-week-label-cell").each(function(e){var t=$(this);var n=e-1;t.css("width",o).css("margin-right","-1px");if(n<0){t.css("height",f*4)}else{if(n%2==0){t.css("border-bottom","none")}else{t.css("border-top","none")}t.css("height",f)}});n.find(".tcal-week-allday-cell").each(function(e){var t=e%7;var n=$(this);if(t==6||t==0)n.css("width",l);else n.css("width",a);n.css("height",f*4);if(t==6)n.css("border-right","1px solid #dedede")});n.find(".tcal-week-halfhour-cell").each(function(t){var n=t%7;var r=$(this);if(n==6||n==0){r.css("width",l);e._weekCellWidth[n]=l}else{r.css("width",a);e._weekCellWidth[n]=a}r.css("height",f);if(n==6)r.css("border-right","1px solid #dedede")});n.find(".tcal-week-agenda-actual").each(function(e){var t=e%7;var n=$(this);var r=n.parent();var i=n.data("width");var s=r.height()/30*i.marginTopOffset;if(t==6||t==0){var o=(l-5-i.intersectCount*4)/i.intersectCount;n.css("width",o).css("margin-top",s).css("height",r.height()*i.numberCellHeight+(i.numberCellHeight-1)*2).css("margin-left",i.startedWidthUnit*(o+4))}else{var o=(a-5-i.intersectCount*4)/i.intersectCount;n.css("width",o).css("margin-top",s).css("height",r.height()*i.numberCellHeight+(i.numberCellHeight-1)*2).css("margin-left",i.startedWidthUnit*(o+4))}})},_weekDate:function(){var e=this;var t=e.element.find(".tcal-grid");var n=e.element.find(".tcal-header-ext");var r=e.element.find(".tcal-header");var i=e.options.date.getMonth();var s=e.options.date.getDate();var o=e.options.date.getFullYear();var u=e.options.date.getDay();var a=new Date(o,i,s-u,0,0,0,0);n.find(".tcal-week-header-cell-date").each(function(t,n){var r=$(this);$(n).html(a.getMonth()+1+"/"+a.getDate());if(e._isToday(a)){r.addClass("tcal-week-today")}else{r.removeClass("tcal-week-today")}a.setTime(a.getTime()+e._millisec_day)});r.find(".tcal-header-primary-title").html(e.options.date.toLocaleDateString()+" - "+a.toLocaleDateString());r.find(".tcal-header-secondary-title").html("");t.find(".tcal-week-halfhour-cell, .tcal-week-allday-cell").each(function(){var e=$(this);e.removeClass("tcal-week-halfhour-allday");e.children().remove()})},_weekPrev:function(){this.options.date.setTime(this.options.date.getTime()-this._millisec_day*7)},_weekNext:function(){this.options.date.setTime(this.options.date.getTime()+this._millisec_day*7)},_weekAgendaWidthOfIndex:function(e,t){return this._monthAgendaWidthOfIndex(e,t)},_weekRefresh:function(){var e=this;var t=e.options.date.getMonth();var n=e.options.date.getFullYear();var r=e.options.date.getDay();var i=e.options.date.getDate();var s=new Date(n,t,i,0,0,0,0);s.setTime(s.getTime()-e._millisec_day*r);var o=new Date(s.getTime()+e._millisec_day*7);var u=e.element.find(".tcal-grid");u.find(".tcal-week-agenda").remove();var a=e.element.find(".tcal-grid-week-scrollpanel");var f=a.find(".tcal-week-allday-cell");var l=[];var c=$(".tcal-grid-week-content .tcal-week-halfhour-cell");var h=$.grep(e.options.agenda,function(t,n){var r=t.startDate.getTime()<o.getTime()&&t.startDate.getTime()>=s.getTime();var i=t.endDate.getTime()<o.getTime()&&t.endDate.getTime()>s.getTime();var u=t.startDate.getTime()<s.getTime()&&t.endDate.getTime()>o.getTime();if(e._isSameDay(t.startDate,t.endDate)&&t.allDay==false){if(r||i){l.push(t)}return false}else{return r||i||u}});var p=function(e){a.find(".tcal-week-halfhour-cell").each(function(t,n){if(t%7==e.getDay()){$(n).addClass("tcal-week-halfhour-allday")}})};h.sort(e._sortAgendaByDate);l.sort(e._sortAgendaByDate);$.each(h,function(t,n){if(e._isSameDay(n.startDate,n.endDate)){var r=$("<div/>",{"class":"tcal-week-allday-agenda tcal-week-allday-agenda-used tcal-week-allday-actual"}).css("background-color",n.color);var i=$("<div/>",{html:n.title,"class":"tcal-week-agenda-title"});r.append(i).css("width",$(f[n.startDate.getDay()]).width()-5);$(f[n.startDate.getDay()]).append(r).addClass("tcal-week-halfhour-allday").data("id",n.id);p(n.startDate);r.click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(r,n)}}else{var u={startedHeight:0,firstday:null};var r;var i=$("<div/>",{html:n.title,"class":"tcal-week-agenda-title"});u.firstday=new Date(n.startDate.getFullYear(),n.startDate.getMonth(),n.startDate.getDate(),0,0,0,0);if(u.firstday.getTime()<s.getTime()){u.firstday.setTime(s.getTime())}var a=$(f[u.firstday.getDay()]).children();if(a.length>0){$.each(a,function(e,t){if($(t).hasClass("tcal-week-allday-agenda-used"))u.startedHeight=e+1;else{return false}});if(a.length>u.startedHeight){r=$(a[u.startedHeight])}else{r=$("<div/>");$(f[u.firstday.getDay()]).append(r)}}else{r=$("<div/>");$(f[u.firstday.getDay()]).append(r)}r.addClass("tcal-week-allday-agenda tcal-week-allday-agenda-used tcal-week-allday-actual").css("background-color",n.color).data("id",n.id);r.click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(r,n)}var l=0;if(n.endDate.getTime()<o){u.upToDate=new Date(n.endDate.getFullYear(),n.endDate.getMonth(),n.endDate.getDate(),0,0,0,0);u.upToDate.setTime(u.upToDate.getTime()+e._millisec_day)}else{u.upToDate=new Date(o.getTime())}l=Math.trunc((u.upToDate.getTime()-u.firstday.getTime())/e._millisec_day);r.css("width",e._weekAgendaWidthOfIndex(u.firstday.getDay(),l));$(f[u.firstday.getDay()]).append(r).addClass("tcal-week-halfhour-allday");p(u.firstday);var c=new Date(u.firstday.getTime());for(;c.getTime()<u.upToDate.getTime();c.setTime(c.getTime()+e._millisec_day)){var h=$(f[c.getDay()]);if(h.children().length<=u.startedHeight){for(var d=h.children().length;d<=u.startedHeight;d++){h.append($("<div/>",{"class":"tcal-week-allday-agenda tcal-week-allday-agenda-used"}).css("width",h.width()-5))}}else{$(h.children()[u.startedHeight]).addClass("tcal-week-allday-agenda-used")}h.addClass("tcal-week-halfhour-allday");p(c)}var v=$("<div/>",{"class":"tcal-week-agenda-allday-start-time"});if(s.getTime()<=n.startDate.getTime()){var m=n.startDate.getHours();var g=n.startDate.getMinutes();v.html((m<10?"0"+m:m)+":"+(g<10?"0"+g:g))}else{v.addClass("tcal-week-not-start-here")}var y=$("<div/>",{"class":"tcal-week-agenda-allday-end-time"});if(o.getTime()>n.endDate.getTime()){var m=n.endDate.getHours();var g=n.endDate.getMinutes();y.html((m<10?"0"+m:m)+":"+(g<10?"0"+g:g))}else{y.addClass("tcal-week-not-end-here")}r.append(v).append(i).append(y)}});$.each(l,function(t,n){var r={column:n.startDate.getDay(),start_loc:{y:n.startDate.getMinutes()>29?1:0},end_loc:{y:n.endDate.getMinutes()>29?1:0},started:false,startedWidthUnit:0,intersectCount:0,numberCellHeight:0,marginTopOffset:n.startDate.getMinutes()%30};r.start_loc.y+=n.startDate.getHours()*2;r.end_loc.y+=n.endDate.getHours()*2;var i=r.column+r.start_loc.y*7;var s=$(c[i]);r.numberCellHeight=(n.endDate.getTime()-n.startDate.getTime())/18e5;var o=$.grep(l,function(e,i){var s=false;var o=false;if(e.startDate.getTime()>=n.endDate.getTime()){s=true}if(e.endDate.getTime()<=n.startDate.getTime()){o=true}if(o==s&&i<t)r.startedWidthUnit++;return o==s});r.intersectCount=o.length;var u=s.height()/30*r.marginTopOffset;var a=(s.width()-r.startedWidthUnit*4-5)/o.length;var f=$("<div/>",{"class":"tcal-week-agenda tcal-week-agenda-used tcal-week-agenda-actual"}).css("background-color",n.color).css("width",a).data("width",r).css("margin-top",u).css("height",s.height()*r.numberCellHeight+(r.numberCellHeight-1)*2).css("margin-left",r.startedWidthUnit*(a+4));var h=$("<div/>",{html:n.title,"class":"tcal-week-agenda-title"});f.append(h).data("id",n.id);s.append(f);f.click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(f,n)}})},_monthGrid:function(){var e=this.element.find(".tcal-grid");e.children().remove();var t=$("<div/>",{"class":"tcal-month-inner-grid"});e.append(t);var n=this.element.find(".tcal-header-ext");n.children().remove();for(var r=0;r<7;r++){var i=$("<div/>",{"class":"tcal-month-week-cell",html:this._weekNameShort[r]});n.append(i)}n.append($("<div/>",{"class":"tcal-clearer"}));for(var r=0;r<42;r++){var i=$("<div/>",{"class":"tcal-month-day-cell"});var s=$("<div/>",{"class":"tcal-month-day-cell-header",html:"<span class='tcal-month-day-cell-header-day'></span>"});var o=$("<div/>",{"class":"tcal-month-day-cell-content"});i.append(s).append(o);t.append(i)}t.append($("<div/>",{"class":"tcal-clearer"}))},_monthDimension:function(){var e=this;var t=e.element.find(".tcal-grid");var n=t.find(".tcal-month-inner-grid");t.css("width",e.element.width()-20);n.css("width",t.width());var r=this.element.find(".tcal-header-ext");var i=t.height();var s=n.width();var o=Math.trunc(s/7);var u=Math.trunc(i/6);var a=(s-o*7)/2+o;var f=i-u*6+u;t.find(".tcal-month-day-cell").each(function(t){var n=t%7;var r=$(this);if(n==6||n==0){r.css("width",a);e._weekCellWidth[n]=a}else{r.css("width",o);e._weekCellWidth[n]=o}if(n==6)r.css("border-right","1px solid #dedede");if(t>34)r.css("height",f);else r.css("height",u)});r.find(".tcal-month-week-cell").each(function(e){var t=e%7;var n=$(this);if(t==6||t==0)n.css("width",a-1);else n.css("width",o-1)});t.find(".tcal-month-agenda-actual").each(function(t){var n=$(this);var r=e._monthAgendaWidthOfIndex(n.data("weekday"),n.data("days"));n.css("width",r)})},_monthDate:function(){var e=this;var t=e.element.find(".tcal-grid");var n=e.element.find(".tcal-header");var r=e.options.date.getMonth();var i=e.options.date.getFullYear();var s=new Date(i,r,1,0,0,0,0);var o=s.getDay();var u=new Date;u.setTime(s.getTime()-e._millisec_day*o);n.find(".tcal-header-primary-title").html(e._monthNameFull[r]);n.find(".tcal-header-secondary-title").html(i);t.find(".tcal-month-day-cell").each(function(t){var n=u.getMonth();var i=u.getDate();var s=$(this);var o=s.find(".tcal-month-day-cell-header-day");o.html(i==1?e._monthNameShort[n]+" 1":i);if(n!=r){s.addClass("tcal-month-different-month")}else{s.removeClass("tcal-month-different-month")}if(e._isToday(u)){s.addClass("tcal-month-today")}else{s.removeClass("tcal-month-today")}u.setTime(u.getTime()+e._millisec_day)})},_monthNext:function(){var e=this;var t=e.options.date.getMonth();e.options.date.setMonth((t+1)%12);if(t==11){e.options.date.setFullYear(e.options.date.getFullYear()+1)}},_monthPrev:function(){var e=this;var t=e.options.date.getMonth();e.options.date.setMonth((t+12-1)%12);if(t==0){e.options.date.setFullYear(e.options.date.getFullYear()-1)}},_monthAgendaWidthOfIndex:function(e,t){var n=0;for(var r=e;r<this._weekCellWidth.length&&r<e+t;r++){n+=this._weekCellWidth[r]}n-=4;return n},_monthRefresh:function(){var e=this;var t=e.options.date.getMonth();var n=e.options.date.getFullYear();var r=new Date(n,t,1,0,0,0,0);var i=new Date(r.getTime()-e._millisec_day*r.getDay());var s=new Date(i.getTime()+e._millisec_day*42);var o=e.element.find(".tcal-grid");o.find(".tcal-month-agenda").remove();var u=$.grep(e.options.agenda,function(e,t){var n=e.startDate.getTime()<s.getTime()&&e.startDate.getTime()>=i.getTime();var r=e.endDate.getTime()<s.getTime()&&e.endDate.getTime()>i.getTime();var o=e.startDate.getTime()<i.getTime()&&e.endDate.getTime()>s.getTime();return n||r||o});u.sort(e._sortAgendaByDate);$.each(u,function(t,n){var r=n.startDate;var s=new Date(i.getTime());if(n.startDate.getTime()<=i.getTime()){r=i}var o={hasStarted:false,startedHeight:0,upToDate:null};e.element.find(".tcal-month-day-cell .tcal-month-day-cell-content").each(function(t,i){var u=$(i);var a=u.children();if(e._isSameDay(s,r)){var f;if(a.length>0){$.each(a,function(e,t){if($(t).hasClass("tcal-month-agenda-used"))o.startedHeight=e+1;else{return false}});if(a.length>o.startedHeight){f=$(a[o.startedHeight])}else{f=$("<div/>");u.append(f)}}else{f=$("<div/>");u.append(f)}f.addClass("tcal-month-agenda tcal-month-agenda-used tcal-month-agenda-actual").css("background-color",n.color).data("id",n.id);var l=$("<div/>",{html:n.title,"class":"tcal-month-agenda-title"});f.append(l).click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(f,n)}o.upToDate=new Date(s.getTime()+(7-s.getDay())*e._millisec_day);if(o.upToDate.getTime()>n.endDate){o.upToDate=new Date(n.endDate.getFullYear(),n.endDate.getMonth(),n.endDate.getDate()+1,0,0,0,0)}var c=Math.ceil((o.upToDate.getTime()-s.getTime())/e._millisec_day);f.data("days",c);f.data("weekday",s.getDay());f.data("id",n.id);var h=e._monthAgendaWidthOfIndex(s.getDay(),c);f.css("width",h);o.hasStarted=true}else if(o.hasStarted){if(s.getTime()<o.upToDate.getTime()){for(var p=a.length;p<o.startedHeight;p++){var f=$("<div/>",{"class":"tcal-month-agenda"}).css("width","100%");u.append(f)}if(a.length<=o.startedHeight){var f=$("<div/>",{"class":"tcal-month-agenda tcal-month-agenda-used"}).css("width","100%");u.append(f)}else{var f=$(u.children()[o.startedHeight]);f.addClass("tcal-month-agenda-used").css("width","100%")}}else if(s.getTime()==o.upToDate.getTime()){o.upToDate=new Date(s.getTime()+(7-s.getDay())*e._millisec_day);if(o.upToDate.getTime()>n.endDate){o.upToDate=new Date(n.endDate.getFullYear(),n.endDate.getMonth(),n.endDate.getDate()+1,0,0,0,0)}if(s.getTime()<o.upToDate.getTime()){f=$("<div/>",{"class":"tcal-month-agenda tcal-month-agenda-used tcal-month-agenda-actual"}).css("background-color",n.color).data("id",n.id);var l=$("<div/>",{html:n.title,"class":"tcal-month-agenda-title"});f.append(l).click(function(t){e._onAgendaClick(this)}).hover(function(){e._onAgendaMouseEnter(this)},function(){e._onAgendaMouseExit(this)});if(e.options.agendaTooltip){e.options.agendaTooltip(f,n)}var d=$("<div/>",{"class":"tcal-month-agenda-continue-container",html:"<"}).css("height","100%");f.append(d);var c=Math.ceil((o.upToDate.getTime()-s.getTime())/e._millisec_day);f.data("days",c);f.data("weekday",s.getDay());f.data("id",n.id);var h=e._monthAgendaWidthOfIndex(s.getDay(),c);f.css("width",h);o.hasStarted=true;u.append(f)}else{return false}}}s.setTime(s.getTime()+e._millisec_day)})})},_yearGrid:function(){var e=this.element.find(".tcal-grid");var t=this.element.find(".tcal-header-ext");e.children().remove();t.children().remove();for(var n=0;n<12;n++){var r=$("<div/>",{"class":"tcal-year-month"});var i=$("<div/>",{"class":"tcal-year-month-label"});var s=$("<div/>",{"class":"tcal-year-month-days"});for(var o=0;o<35;o++){var u=$("<div/>",{"class":"tcal-year-month-day"});s.append(u)}r.append(i).append(s);e.append(r)}},_yearDimension:function(){var e=this;var t=this.element.find(".tcal-grid");t.css("width",e.element.width()-20);var n=t.width();var r=t.height();var i=r/3;var s=n/4;t.find(".tcal-year-month").each(function(e,t){var n=$(this);n.css("width",s).css("height",i);n.find(".tcal-year-month-label").css("height",20);n.find(".tcal-year-month-days").css("height",i-20)});var o=(i-20)/5-2;var u=s/7-2;t.find(".tcal-year-month-day").each(function(){$(this).css("width",u).css("height",o)})},_yearDate:function(){var e=this;var t=this.element.find(".tcal-grid");var n=e.options.date.getFullYear();var r=e.element.find(".tcal-header");r.find(".tcal-header-primary-title").html("");r.find(".tcal-header-secondary-title").html(n);t.find(".tcal-year-month-label").each(function(t){$(this).html(e._monthNameFull[t]).addClass("clickable").data("month",t).click(function(t){e.options.date.setMonth($(this).data("month"));e._todayDatePicker.datepicker("setDate",e.options.date);e.changeMode("m")})});var i=new Date;t.find(".tcal-year-month").each(function(t){var r=new Date(n,t,1,0,0,0,0);$(this).find(".tcal-year-month-day").each(function(n){if(r.getMonth()==t&&n>=r.getDay()){var s=$(this);s.addClass("clickable").data("date",r.getTime()).click(function(t){e.options.date=new Date(s.data("date"));e._todayDatePicker.datepicker("setDate",e.options.date);e.changeMode("d")});if(i.getMonth()==t&&i.getDate()==r.getDate()){s.html("<span class='tcal-year-month-date tcal-year-month-today'>"+r.getDate()+"</span>").removeClass("tcal-year-month-date-booked").removeClass("tcal-year-month-date-booked-multi")}else{s.html("<span class='tcal-year-month-date'>"+r.getDate()+"</span>").removeClass("tcal-year-month-date-booked").removeClass("tcal-year-month-date-booked-multi")}r.setTime(r.getTime()+e._millisec_day)}else{$(this).html("&nbsp;").removeClass("clickable").removeClass("tcal-year-month-date-booked").removeClass("tcal-year-month-date-booked-multi").off("click").data("date",null)}})})},_yearNext:function(){this.options.date.setTime(this.options.date.getTime()+this._millisec_year)},_yearPrev:function(){this.options.date.setTime(this.options.date.getTime()-this._millisec_year)},_yearRefresh:function(){var e=this;var t=this.element.find(".tcal-grid");var n=this.options.date.getFullYear();var r=new Date(n,0,1,0,0,0,0);var i=new Date(r.getTime()+e._millisec_year);var s=0;var o=0;var u=$.grep(e.options.agenda,function(e,t){var n=e.startDate.getTime()<i.getTime()&&e.startDate.getTime()>=r.getTime();var s=e.endDate.getTime()<i.getTime()&&e.endDate.getTime()>r.getTime();var u=e.startDate.getTime()<r.getTime()&&e.endDate.getTime()>i.getTime();if(n||s||u){if(e.startDate.getTime<r.getTime())o++;return true}return false});if(u.length==0)return;t.find(".tcal-year-month").each(function(t){var r=new Date(n,t,1,0,0,0,0);$(this).find(".tcal-year-month-day").each(function(n){if(r.getMonth()==t&&n>=r.getDay()){while(e._isSameDay(u[s].startDate,r)){o++;s++}var i=$(this);switch(o){case 0:i.removeClass("tcal-year-month-date-booked").removeClass("tcal-year-month-date-booked-multi");break;case 1:i.addClass("tcal-year-month-date-booked");break;default:i.addClass("tcal-year-month-date-booked-multi");break}for(var a=0;a<s;a++){if(e._isSameDay(r,u[a].endDate))o--}r.setTime(r.getTime()+e._millisec_day)}else{$(this).removeClass("tcal-year-month-date-booked").removeClass("tcal-year-month-date-booked-multi")}})})}})